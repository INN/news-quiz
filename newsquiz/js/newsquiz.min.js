/*! newsquiz - v0.1.0 - 2014-02-20 
* https://github.com/motherjones/newsquiz
* Copyright (c) 2014 Ben Breedlove; Licensed MIT, GPL */
!function(a){function b(a,b){var c=1===a?"answer":"answers";return'You got <span class="correct_answers">'+a+"</span> correct "+c+" out of "+b+" questions"}function c(a){for(var c=[],d=0;a>=d;d++)c.push(b(d,a));return c}a.quiz=function(b,d,e){var f,g,h,i,j=[],k=[],l={defaulting_behavior_on:!0,defaulting_flag:"!default",container:"quiz_container",not_finished_html:void 0,cheating:!1,possible_display_elements:[{name:"backgroundimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<div class="'+this.name+'" style="background-image: url(\''+b[this.name]+"'); height: 100%; width: 100%;position:absolute;z-index: -1\"></div>"):""}},{name:"topimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<img src="'+b[this.name]+'" class="'+this.name+'"></img>'):""}},{name:"topvideoembed",finder:function(a){return a.find("."+this.name)},needs_aspect_ratio:!0,create_element:function(b){return b.topvideoembedaspectratio?a('<div class="videoembed '+this.name+'" style="padding-bottom:'+b.topvideoembedaspectratio+'%">'+b[this.name]+"</div>"):""}},{name:"title",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<h1 class="'+this.name+'">'+b[this.name]+"</h1>"):""}},{name:"middleimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<img src="'+b[this.name]+'" class="'+this.name+'"></img>'):""}},{name:"middlevideoembed",needs_aspect_ratio:!0,finder:function(a){return a.find("."+this.name)},create_element:function(b){return b.middlevideoembedaspectratio?a('<div class="videoembed '+this.name+'" style="padding-bottom:'+b.middlevideoembedaspectratio+'%">'+b[this.name]+"</div>"):""}},{name:"subhed",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<h2 class="'+this.name+'">'+b[this.name]+"</h2>"):""}},{name:"text",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<p class="'+this.name+'">'+b[this.name]+"</p>"):""}},{name:"bottomimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<img src="'+b[this.name]+'" class="'+this.name+'"></img>'):""}},{name:"bottomvideoembed",needs_aspect_ratio:!0,finder:function(a){return a.find("."+this.name)},create_element:function(b){return b.bottomvideoembedaspectratio?a('<div class="videoembed '+this.name+'" style="padding-bottom:'+b.bottomvideoembedaspectratio+'%">'+b[this.name]+"</div>"):""}}],init:function(a,b,d){if(g=this,d)for(var e in d)g[e]=d[e];return"string"==typeof a?g.load_from_google_spreadsheet(a):(b||(b=c(a.length)),g.init_data(a,b)),g},init_data:function(a,b){g.quiz_data=a,g.results_data=b,g.calculate_aspectratios(a),g.create_cover();for(var c=0;c<g.quiz_data.length;c++)g.append_question(c);g.append_how_you_did_section(),g.update_how_you_did_element()},append_how_you_did_section:function(){i=a('<p class="how_you_did"></p>'),h.append(i)},load_from_google_spreadsheet:function(a){Tabletop.init({key:a,callback:function(a){var b=g.make_quiz_data_from_spreadsheet_data(a),c=g.make_results_data_from_spreadsheet_data(a,b);g.init_data(b,c)}})},calculate_aspectratios:function(a){for(var b=0;b<a.length;b++){for(var c=a[b],d=0;d<c.possible_answers.length;d++){var e=c.possible_answers[d];g.find_aspectratio_for_each_type_of_video_embed(e)}g.find_aspectratio_for_each_type_of_video_embed(c.question)}},find_aspectratio_for_each_type_of_video_embed:function(a){for(var b=0;b<g.possible_display_elements.length;b++){var c=g.possible_display_elements[b];c.needs_aspect_ratio&&a[c.name]&&(a[c.name+"aspectratio"]=g.find_aspectratio(a[c.name]))}},find_aspectratio:function(a){var b=a.match(/height="\d+"/);if(!b||!b[0])return console.log("Your video embed code needs a height."),"";b=parseInt(b[0].replace(/height="/,"").replace(/"/,""),10);var c=a.match(/width="\d+"/);return c&&c[0]?(c=parseInt(c[0].replace(/width="/,"").replace(/"/,""),10),b/c*100):(console.log("Your video embed code needs a width."),"")},pull_answer_value_from_spreadsheet:function(a,b,c,d){return d=d?"right":"wrong",a[d+c+b]&&a[d+c+b]!==g.defaulting_flag?a[d+c+b]:g.defaulting_behavior_on&&a[d+c+b]!==g.defaulting_flag||!g.defaulting_behavior_on&&a[d+c+b]===g.defaulting_flag?a[d+b]&&a[d+b]!==g.defaulting_flag?a[d+b]:a["answer"+b]&&a["answer"+b]!==g.defaulting_flag?a["answer"+b]:a["question"+b]:""},get_possible_answers:function(a,b){var c=[],d=b?"right":"wrong";a[d]&&c.push(g.make_possible_answer(a,"",b));for(var e=0;10>e;e++)a[d+e]&&c.push(g.make_possible_answer(a,e,b));return c},make_possible_answer:function(a,b,c){for(var d=c?"right":"wrong",e={answer:a[d+b],correct:c},f=0;f<g.possible_display_elements.length;f++){var h=g.possible_display_elements[f].name;e[h]=g.pull_answer_value_from_spreadsheet(a,h,b,c)}return e},make_quiz_data_from_spreadsheet_data:function(a){var b,c,d,e,f=[];for(d in a)if(a.hasOwnProperty(d)&&"Results"!==d)break;for(e=a[d].elements,b=0;b<e.length;b++){var h=e[b],i=g.get_possible_answers(h,!1),j=g.get_possible_answers(h,!0),k=[];for(c=0;c<j.length;c++)k.push(Math.round(Math.random()*i.length));k.sort();var l=[],m=0;for(c=0;c<=i.length;c++){for(;c===k[m];)l.push(j[m]),m++;c!==i.length&&l.push(i[c])}var n={question:{},possible_answers:l,rowNumber:h.rowNumber-1};for(c=0;c<g.possible_display_elements.length;c++){var o=g.possible_display_elements[c].name;n.question[o]=h["question"+o]}f.push(n)}return f},make_results_data_from_spreadsheet_data:function(a,b){for(var d=c(b.length),e=a.Results?a.Results.elements:[],f=0;f<e.length;f++){var g=e[f].numberofrightanswers;g&&(g=parseInt(g,10)),isNaN(g)||(d[g]?d[g]=e[f].html:console.log("Invalid number of correct answers: "+g))}return d},append_question:function(b){var c=g.quiz_data[b],d=a('<li class="question_container row-fluid question_'+b+'"></li>');d.append(g.build_question_element_from_row(c)),d.append(g.build_possible_answer_elements_from_row(c,b)),f.append(d)},build_question_element_from_row:function(b){for(var c=a('<div class="question col-12 show" style="overflow: hidden; position: relative;"></div>'),d=0;d<g.possible_display_elements.length;d++)c.append(g.possible_display_elements[d].create_element(b.question));return c},build_possible_answer_elements_from_row:function(b,c){function d(b,c,d){d.bind("click",function(){var d=g.quiz_data[b].possible_answers[c].correct;e.find(".selected").removeClass("selected"),a(this).addClass("selected"),a(this).removeClass("possible_answer"),e.find(".answer_"+c).addClass(d?"correct_answer":"wrong_answer"),j[b]=d,"undefined"==typeof k[b]&&(k[b]=d,h.find(".question_"+b).addClass("first_guess_"+(d?"right":"wrong"))),g.update_how_you_did_element(),g.display_answer(g.quiz_data[b],b,g.quiz_data[b].possible_answers[c]),g.quiz_data[b].previously_selected=g.quiz_data[b].possible_answers[c]})}for(var e=a('<ul class="col-12 possible_answers possible_answers_'+c+'"></ul>'),f=0;f<b.possible_answers.length;f++){var i=b.possible_answers[f],l=a('<li class="possible_answer col-12 answer_'+f+'">'+i.answer+"</li>");d(c,f,l),e.append(l)}return e},add_display_in_correct_place:function(a,b,c){for(var d=b;d>0;d--)if(g.possible_display_elements[d-1].finder(a).length)return void g.possible_display_elements[d-1].finder(a).after(g.possible_display_elements[b].create_element(c));a.prepend(g.possible_display_elements[b].create_element(c))},display_answer:function(a,b,c){var d=a.previously_selected?a.previously_selected:a.question,e=f.find(".question_"+b+" .question");e.addClass("revealed_answer");for(var h=0;h<g.possible_display_elements.length;h++){var i=g.possible_display_elements[h].name;c[i]!==d[i]&&(c[i]?d[i]?g.possible_display_elements[h].finder(e).before(g.possible_display_elements[h].create_element(c)).remove():g.add_display_in_correct_place(e,h,c):g.possible_display_elements[h].finder(e).remove())}},create_cover:function(){h=a("#"+g.container),f=a("<ul></ul>"),h.append(f),f.addClass("quiz_container"),f.css("padding","0px")},update_how_you_did_element:function(){for(var a=0,b=g.cheating?j:k,c=!1,d=0;d<g.quiz_data.length;d++)"undefined"==typeof k[d]&&(c=!0),b[d]&&a++;var e;e=c&&"undefined"!=typeof this.not_finished_html?this.not_finished_html:this.results_data[a],i.html(e)}};return l.init(b,d,e)},a.fn.quiz=function(b,c,d){return d||(d=c,c=null),d||(d={}),d.container=this.attr("id"),this.quiz=a.quiz(b,c,d),this}}(jQuery);